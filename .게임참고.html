<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Single Web RPG</title>
    <style>
        body {
            margin: 0;
            background: #111;
            overflow: hidden;
        }

        canvas {
            background: #2c2c2c;
            display: block;
            margin: auto;
        }

        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-family: Arial;
        }
    </style>
</head>

<body>

    <div id="ui"></div>
    <canvas id="gameCanvas" width="800" height="600"></canvas>

    <script>
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        const ui = document.getElementById("ui");

        const TILE_SIZE = 64;
        const FRAME_SIZE = 64;
        const FRAMES = 6;

        const sprite = new Image();
        sprite.src = "public/assets/knight_sheet.png";

        const map = [
            [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
            [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
            [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
            [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
            [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
            [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
        ];

        const player = {
            x: 200,
            y: 200,
            hp: 100,
            maxHp: 100,
            attack: 10,
            defense: 2,
            level: 1,
            exp: 0,
            speed: 2,
            direction: 0,
            frame: 0
        };

        class Monster {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.hp = 40;
                this.maxHp = 40;
                this.attack = 5;
                this.defense = 1;
                this.alive = true;
            }

            update() {
                if (!this.alive) return;

                const dx = player.x - this.x;
                const dy = player.y - this.y;
                const dist = Math.sqrt(dx * dx + dy * dy);

                if (dist < 200) {
                    this.x += dx * 0.01;
                    this.y += dy * 0.01;
                }

                if (dist < 50) {
                    player.hp -= 0.05;
                }
            }

            draw() {
                if (!this.alive) return;
                ctx.fillStyle = "red";
                ctx.fillRect(this.x - 15, this.y - 15, 30, 30);

                ctx.fillStyle = "black";
                ctx.fillRect(this.x - 20, this.y - 30, 40, 5);

                ctx.fillStyle = "lime";
                ctx.fillRect(this.x - 20, this.y - 30, (this.hp / this.maxHp) * 40, 5);
            }
        }

        const monster = new Monster(500, 300);

        let keys = {};

        document.addEventListener("keydown", e => {
            keys[e.key.toLowerCase()] = true;
            if (e.code === "Space") attack();
        });
        document.addEventListener("keyup", e => {
            keys[e.key.toLowerCase()] = false;
        });

        function isWalkable(x, y) {
            const tx = Math.floor(x / TILE_SIZE);
            const ty = Math.floor(y / TILE_SIZE);
            return map[ty][tx] === 0;
        }

        function movePlayer() {
            let dx = 0, dy = 0;

            if (keys["w"]) dy -= player.speed;
            if (keys["s"]) dy += player.speed;
            if (keys["a"]) dx -= player.speed;
            if (keys["d"]) dx += player.speed;

            const newX = player.x + dx;
            const newY = player.y + dy;

            if (isWalkable(newX, newY)) {
                player.x = newX;
                player.y = newY;
            }
        }

        function attack() {
            if (!monster.alive) return;

            const dx = player.x - monster.x;
            const dy = player.y - monster.y;
            const dist = Math.sqrt(dx * dx + dy * dy);

            if (dist < 80) {
                const damage = Math.max(1, player.attack - monster.defense + Math.random() * 3);
                monster.hp -= damage;

                if (monster.hp <= 0) {
                    monster.alive = false;
                    gainExp(20);
                }
            }
        }

        function gainExp(amount) {
            player.exp += amount;
            if (player.exp >= player.level * 50) {
                player.exp = 0;
                player.level++;
                player.maxHp += 20;
                player.attack += 5;
                player.hp = player.maxHp;
            }
        }

        function drawMap() {
            for (let y = 0; y < map.length; y++) {
                for (let x = 0; x < map[y].length; x++) {
                    ctx.fillStyle = map[y][x] === 1 ? "#444" : "#777";
                    ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                }
            }
        }

        function drawPlayer() {
            ctx.fillStyle = "blue";
            ctx.fillRect(player.x - 15, player.y - 15, 30, 30);
        }

        function updateUI() {
            ui.innerHTML = `
  HP: ${Math.floor(player.hp)} / ${player.maxHp} <br>
  LV: ${player.level} <br>
  EXP: ${player.exp}
  `;
        }

        function update() {
            movePlayer();
            monster.update();
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawMap();
            drawPlayer();
            monster.draw();
        }

        function loop() {
            update();
            draw();
            updateUI();
            requestAnimationFrame(loop);
        }

        loop();
    </script>

</body>

</html>